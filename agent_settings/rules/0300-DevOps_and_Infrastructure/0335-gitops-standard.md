---
trigger: model_decision
glob: ["**/argocd/**/*.{yaml,yml}", "**/applicationset.yaml", "**/application.yaml"]
description: "GitOps & ArgoCD Standards: Enforces declarative state management, automated synchronization, and drift correction."
---

# GitOps & ArgoCD Standards

- **Role**: GitOps Platform Engineer
- **Purpose**: Define standards for the declarative, automated, and version-controlled deployment of applications and infrastructure using GitOps principles and ArgoCD.
- **Activates When**: Configuring ArgoCD applications, defining ApplicationSets, or managing GitOps manifests.

**Trigger**: model_decision â€” Apply during the design and orchestration of GitOps-driven deployment pipelines.

## 1. Standards

### Principles

- **[REQ-GPT-01] Git as Authority**
  - All infrastructure and application configurations MUST reside in Git. Direct, ad-hoc modifications to the cluster state are PROHIBITED.
- **[REQ-GPT-02] Declarative Desired State**
  - Configurations MUST be defined using declarative manifests (Kustomize/Helm). Imperative `kubectl` commands MUST NOT be part of the deployment lifecycle.
- **[REQ-GPT-03] Automated Remediation**
  - ArgoCD MUST be configured with `selfHeal: true` where applicable to automatically correct configuration drift between Git and the cluster.

### GitOps Baseline

| Feature | Requirement ID | Critical Implementation |
| --- | --- | --- |
| Sync Policy | [REQ-GPT-04] | `automated` (dev/stg) / `manual` (prod) |
| Isolation | [REQ-GPT-05] | Dedicated namespaces per Application |
| Pruning | [REQ-GPT-06] | `prune: true` to eliminate orphaned resources |
| Multi-Env | [REQ-GPT-07] | `ApplicationSet` for cross-cluster orchestration |

### Must

- **[REQ-GPT-08] Explicit Revision Pinning**
  - ArgoCD applications MUST pin their source to a specific `targetRevision` (e.g., semantic tag or SHA) to ensure reproducible deployments.
- **[REQ-GPT-09] Modular Repository Architecture**
  - Application source code and deployment manifests SHOULD be separated into distinct repositories to prevent CI/CD recursion loops.
- **[REQ-GPT-10] Standardized Sync Waves**
  - Utilize `argocd.argoproj.io/sync-wave` annotations to explicitly control the deployment order of complex dependencies (e.g., DB before App).

### Must Not

- **[BAN-GPT-01] Plain-Text Secret Commitment**
  - Secrets MUST NOT be committed to Git in plain text. Utilize Sealed Secrets, External Secrets, or Vault-based injection.
- **[BAN-GPT-02] Non-Deterministic 'Latest' Tags**
  - Using the `latest` image tag in manifests is STRICTLY PROHIBITED; utilize immutable tags generated by the build pipeline.

### Failure Handling

- **Stop Condition**: Stop synchronization if the "Health Check" identified a persistent `Degraded` status on a critical application component.

## 2. Procedures

- **[PROC-GPT-01] Drift Reconciliation**
  - IF ArgoCD identifies a drift in a production environment THEN MUST perform a Git-driven "Sync" rather than a manual cluster patch.
- **[PROC-GPT-02] Version Promotion Flow**
  - Utilize Kustomize overlays or Helm values to promote versions systematically from `development` to `staging` and finally `production`.

## 3. Examples

### Clean Application Manifest (Good)

```yaml
spec:
  source:
    repoURL: https://github.com/org/config-repo
    path: overlays/prod
    targetRevision: v1.2.3
  syncPolicy:
    automated: { prune: true, selfHeal: true }
```

## 4. Validation Criteria

- **[VAL-GPT-01] Synchronicity Audit**
  - [ ] ArgoCD dashboard confirms that 100% of applications are in the `Synced` and `Healthy` state.
- **[VAL-GPT-02] Security Gate Verification**
  - [ ] Audit confirms that zero applications utilize plain-text Kubernetes Secrets within the Git repository.
- **[VAL-GPT-03] Rollback Efficiency**
  - [ ] Verification confirms that a `git revert` on the config repo triggers a successful cluster rollback within < 5 minutes.
